# trivy-security-scan
The provided GitHub Actions workflow, named "Trivy Security Scan," is designed to scan a Docker image for security vulnerabilities using Trivy and optionally upload the scan results to an S3 bucket. Here's how you can use this workflow:

## Workflow Steps
1. **Checkout Repository** :
\This step checks out your repository to access the necessary source code and configuration files.

2. **Run Trivy Security Scan**:\
Trivy is used to perform the security scan on the specified container image using the provided parameters.

3. **Upload Trivy Scan Results to S3 Bucket** (Optional): If enabled, the action can upload the scan results to an Amazon S3 bucket, making them accessible for further analysis and archiving.

## Inputs
| Name | Description | Default | Required |
|------|-------------|---------|:--------:|
|`environment`| The name of the environment for the scan.||`true`|
|`image-ref`| The reference of the container image to be scanned.||`true`|
| `vuln-type`| The type of vulnerabilities to scan for.| `os,library`||
| `severity`| The severity levels of vulnerabilities to consider. | `CRITICAL,HIGH` ||
| `format`| The format of the security scan result.| `json`||
| `exit-code`| The exit code when specified vulnerabilities are found.|`0`||
| `output-extension` | The extension of the output file generated by the scan.| `json`||
| `upload-result-s3-enable` | A variable for enabling the upload of the security scan result to an Amazon S3 bucket. | `false` ||
| `s3-region`| The region of the Amazon S3 bucket where the scan results will be uploaded. | `ap-southeast-1` ||
| `s3-bucket`| The name of the Amazon S3 bucket where the scan results will be uploaded. | `trivy-security-scan-result` ||


## Usage
```yaml
step:
- name: Run Trivy vulnerability scanner
  uses: nxz-group/github-shared-workflows/.github/actions/trivy-security-scan@main
  with:
    environment: 'prd'
    image-ref: 'docker.io/myuser/myapp:latest'
    vuln-type: 'os,library,app'
    severity: 'CRITICAL,HIGH,MEDIUM'
    format: 'json'
    exit-code: '0'
    output-extension: 'json'
    upload-result-s3-enable: 'true'
    s3-region: 'ap-southeast-1'
    s3-bucket: 'my-security-scans'
```
## Example Usage
1. **Create a Workflow File**:\
In your repository, create a directory named `.github/workflows` if it doesn't already exist. Inside this directory, create a YAML workflow file, for example, `trivy-security-scan.yaml`.

2. **Define the Workflow**:\
In the workflow file, define the workflow structure. Here's an example of what the content might look like:
```yaml
name: "Security Scan Workflow"

on:
  push:
    branches:
      - main

jobs:
  security_scan:
    name: "vulnerability scanner"
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Run Trivy vulnerability scanner
      uses: nxz-group/github-shared-workflows/.github/actions/trivy-security-scan@main
      with:
        environment: 'prd'
        image-ref: 'docker.io/myuser/myapp:latest'
        upload-result-s3-enable: 'true'
        s3-region: 'ap-southeast-1'
        s3-bucket: 'my-security-scans'

```

### Fail when found vulnerability and upload artifact to Github
```yaml
    - name: Run Trivy vulnerability scanner
        uses: nxz-group/github-shared-workflows/.github/actions/trivy-security-scan@main
        with:
          environment: dev
          image-ref: 'docker.io/myuser/myapp:latest'
          s3-bucket: 'my-security-scans'
          upload-result-s3-enable: true
          exit-code: 1
          upload-artifact-enable: true
```
3. **Commit the Workflow**:\
Commit the workflow file `trivy-security-scan.yaml` to your repository and push the changes.
